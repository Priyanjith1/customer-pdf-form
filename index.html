<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Signature Form</title>
    <style>
    body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f4f4f4;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.header {
    text-align: center;
    margin-bottom: 20px;
}

.header h1 {
    margin: 0;
    font-size: 24px;
}

.form-image {
    margin-bottom: 15px;
    text-align: center;
}

.form-image img {
    max-width: 100%;
    height: auto;
}

.form-group-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    margin-bottom: 15px;
}

.form-group-left,
.form-group-right {
    flex: 1 1 48%;
    margin-bottom: 15px;
}

.form-group-left input,
.form-group-right input {
    width: 100%;
    box-sizing: border-box;
}

.form-group {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
}

.signature-pad {
    border: 1px solid #000;
    width: 100%;
    height: 150px;
    box-sizing: border-box;
    touch-action: none;
}

.checkbox-group {
    margin-bottom: 20px;
}

.checkbox-items {
    display: flex;
    flex-wrap: wrap;
}

.checkbox-item {
    width: 50%;
    margin-bottom: 10px;
}

.comments-container,
.signature-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.comments-container textarea,
.signature-container textarea {
    width: 100%;
    height: 100px;
    box-sizing: border-box;
}

#loading-message {
            display: none; /* Hide initially */
            color: blue;
            font-weight: bold;
            margin-top: 20px;
            text-align: center; /* Center align the message */
        }


#message {
    display: none;
    color: green;
    margin-top: 20px;
    font-weight: bold;
}

.contact-details {
    margin-top: 20px;
    padding: 15px;
    background: #e9ecef;
    border-radius: 8px;
    border: 1px solid #ccc;
}

.contact-details h3 {
    margin: 0 0 10px;
    font-weight: bold;
}

.form-date {
    margin-bottom: 15px;
    text-align: right;
}

@media (max-width: 600px) {
    .form-group-container {
        flex-direction: column;
    }

    .form-group-left,
    .form-group-right {
        flex: 1 1 100%;
        margin-bottom: 10px;
    }

    .form-date {
        text-align: left;
    }

    .checkbox-item {
        width: 100%;
    }
    
    .comments-container,
    .signature-container {
        flex-direction: column;
    }
}

        
    </style>
</head>

<body>
    <div class="container">
        <div class="form-image">
            <img src="https://raw.githubusercontent.com/Priyanjith1/customer-pdf-form/main/index__new.png.png" alt="Form Image">
         </div>
    
         <div class="header">
            <h1>Elevator Service/Breakdown/Inspection Sheet</h1>
          </div>
          
        

        <form id="document-form">

            <div class="form-date">
                <strong><label for="date">Date:</strong></label>
                <input type="date" id="date" name="date" required>
    
               </div>
    
               <div class="form-group-container">
                <div class="form-group-left">
                    <strong><label for="name">Name of the client/site:</strong></label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group-left">
                    <strong><label for="email">Email:</strong></label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group-right">
                    <strong><label for="units">No of Units:</strong></label>
                    <input type="number" id="number" name="units" required>
                </div>
                <div class="form-group-right">
                    <strong><label for="specifications">Specifications:</strong></label>
                    <input type="text" id="specifications" name="specifications" required> 
                </div>
            </div>

            <div class="checkbox-group">
                <label><strong>Select the services performed (At least one required):</strong></label><p>
                <input type="checkbox" id="service1" name="services" value="Inspection">
                <label for="service1">Inspection</label>
                <input type="checkbox" id="service2" name="services" value="Repair">
                <label for="service2">Repair</label>
                <input type="checkbox" id="service3" name="services" value="Maintenance">
                <label for="service3">Maintenance</label>
            </div>

            <div class="checkbox-group">
                <label><strong>Select the inspection/maintenance items:</strong></label><p>
                <div class="checkbox-items">
                    <div class="checkbox-item">
                        <input type="checkbox" id="item1" name="items" value="Motor room condition">
                        <label for="item1">Motor room condition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item2" name="items" value="Control panel etc.">
                        <label for="item2">Control panel etc.</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item3" name="items" value="Traction motor">
                        <label for="item3">Traction motor</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item4" name="items" value="Governor">
                        <label for="item4">Governor</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item5" name="items" value="Automatic Rescue Device (ARD)">
                        <label for="item5">Automatic Rescue Device (ARD)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item6" name="items" value="Traveling condition">
                        <label for="item6">Traveling condition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item7" name="items" value="Inter-Phone, Bell">
                        <label for="item7">Inter-Phone, Bell</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item8" name="items" value="Emergency Light">
                        <label for="item8">Emergency Light</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item9" name="items" value="Fan, Light & Interior">
                        <label for="item9">Fan, Light & Interior</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item10" name="items" value="Intercom & Buttons">
                        <label for="item10">Intercom & Buttons</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item11" name="items" value="Car Door & Sill">
                        <label for="item11">Car Door & Sill</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item12" name="items" value="Safety Edge">
                        <label for="item12">Safety Edge</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item13" name="items" value="Door Condition">
                        <label for="item13">Door Condition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item14" name="items" value="Landing Door & Sill">
                        <label for="item14">Landing Door & Sill</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item15" name="items" value="Hall Operation Panel (HOP)">
                        <label for="item15">Hall Operation Panel (HOP)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item16" name="items" value="Cage Top Condition">
                        <label for="item16">Cage Top Condition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item17" name="items" value="Door Motor">
                        <label for="item17">Door Motor</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item18" name="items" value="Guide Shoes">
                        <label for="item18">Guide Shoes</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item19" name="items" value="Oil Pan">
                        <label for="item19">Oil Pan</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item20" name="items" value="Pit condition">
                        <label for="item20">Pit condition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item21" name="items" value="Traveling Cable">
                        <label for="item21">Traveling Cable</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item22" name="items" value="Traction Machine">
                        <label for="item22">Traction Machine</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item23" name="items" value="Buffer Condition">
                        <label for="item23">Buffer Condition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="item24" name="items" value="Operation without Lubrication">
                        <label for="item24">Operation without Lubrication</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <strong><label for="Replaced/Repaired item">Replaced/Repaired item:</strong></label>
                <input type="text" id="Replaced/Repaired item" name="Replaced/Repaired item">
            </div>

            <div class="form-group">
                <strong><label for="Serial N0">Serial N0:</strong></label>
                <input type="text" id="Serial N0" name="Serial N0">
            </div>

            <div class="comments-container">
                <div class="comment-section">
                    
                    <textarea id="client-comment" name="client-comment" placeholder="Client's Comments"></textarea>
                    <label for="client-comment">I hereby acknowledge that the aforementioned routine was carried out with my full awareness and I am satisfied with the service provided</label>
                </div>
                <div class="comment-section">
                    <label for="technician-comment"></label>
                    <textarea id="technician-comment" name="technician-comment" placeholder="Technician's Comments"></textarea>
                </div>
            </div>

            <div class="signature-container">
                <div>
                    <div class="form-group">
                        <strong><label for="client-name">Client Name:</strong></label>
                        <input type="text" id="client-name" name="client-name" required>
                    </div>
                    <div class="form-group">
                        <strong><label for="client-nic">NIC No:</strong></label>
                        <input type="text" id="client-nic" name="client-nic" required>
                    </div>
                    <div class="form-group">
                        <strong><label for="client-signature">Client's Signature:</strong></label>
                        <canvas id="client-signature" class="signature-pad"></canvas>
                        <input type="hidden" id="client-signature-data" name="client-signature" required>
                        <button type="button" id="clear-client-signature">Clear Signature</button>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <strong><label for="technician-name">Technician Name:</strong></label>
                        <input type="text" id="technician-name" name="technician-name" required>
                    </div>
                    <div class="form-group">
                        <strong><label for="technician-nic">NIC No:</strong></label>
                        <input type="text" id="technician-nic" name="technician-nic" required>
                    </div>
                    <div class="form-group">
                        <strong><label for="technician-signature">Technician's Signature:</strong></label>
                        <canvas id="technician-signature" class="signature-pad"></canvas>
                        <input type="hidden" id="technician-signature-data" name="technician-signature" required>
                        <button type="button" id="clear-technician-signature">Clear Signature</button>
                    </div>
                </div>
            </div>

            <button type="submit">Submit</button>
        </form>

        <div id="loading-message">Please wait, the form is submitting...</div>

        <div id="message">Form successfully submitted and PDF generated!</div>

        <div class="contact-details">
            <h3>Contact Details</h3>
            <p><strong>Phone:                 </strong>+94 (11) 779 2800</p>
            <p><strong>Emergency No:</strong> +94 (77) 925 9970</p>
            <p><strong>Email:</strong>        info@gssolutions.lk</p>
            <p><strong>Address:</strong>      12 Don Carolis Rd, Colombo 005</p>
        </div>
    
        <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
        
        <script>
            // Signature pad initialization and event listeners...
            const clientCanvas = document.getElementById('client-signature');
            const technicianCanvas = document.getElementById('technician-signature');
            const clientSignaturePad = new SignaturePad(clientCanvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'black'
            });
            const technicianSignaturePad = new SignaturePad(technicianCanvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'black'
            });


                  // Prevent page scrolling when drawing on canvas
            function disableScroll() {
                document.body.style.overflow = 'hidden';
            }

            function enableScroll() {
                document.body.style.overflow = 'auto';
            }

            clientCanvas.addEventListener('touchstart', function (event) {
                event.preventDefault();
                disableScroll();
            });

            clientCanvas.addEventListener('touchend', function (event) {
                event.preventDefault();
                enableScroll();
            });

            technicianCanvas.addEventListener('touchstart', function (event) {
                event.preventDefault();
                disableScroll();
            });

            technicianCanvas.addEventListener('touchend', function (event) {
                event.preventDefault();
                enableScroll();
            });

            clientCanvas.addEventListener('touchmove', function(event) {
                event.preventDefault();
            }, { passive: false });

            technicianCanvas.addEventListener('touchmove', function(event) {
                event.preventDefault();
            }, { passive: false });

            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                
                // Save the signature data before resizing
                const clientSignatureData = clientSignaturePad.toData();
                const technicianSignatureData = technicianSignaturePad.toData();
                
                clientCanvas.width = clientCanvas.offsetWidth * ratio;
                clientCanvas.height = clientCanvas.offsetHeight * ratio;
                clientCanvas.getContext("2d").scale(ratio, ratio);
                
                technicianCanvas.width = technicianCanvas.offsetWidth * ratio;
                technicianCanvas.height = technicianCanvas.offsetHeight * ratio;
                technicianCanvas.getContext("2d").scale(ratio, ratio);

                // Restore the signature data after resizing
                clientSignaturePad.fromData(clientSignatureData);
                technicianSignaturePad.fromData(technicianSignatureData);
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            document.getElementById('clear-client-signature').addEventListener('click', function () {
                clientSignaturePad.clear();
            });
        
            document.getElementById('clear-technician-signature').addEventListener('click', function () {
                technicianSignaturePad.clear();
            });

        
            document.getElementById('document-form').addEventListener('submit', async function (event) {
    event.preventDefault();
    console.log('Form submission started.');

    document.getElementById('loading-message').style.display = 'block';


    let servicesSelected = document.querySelectorAll('input[name="services"]:checked');
    if (servicesSelected.length === 0) {
        alert('Please select at least one service.');

        document.getElementById('loading-message').style.display = 'none';
        return;
    }


    if (clientSignaturePad.isEmpty() || technicianSignaturePad.isEmpty()) {
        alert('Please provide signatures.');

        document.getElementById('loading-message').style.display = 'none';
        return;
    }

   

    // Get the email address from the form
    const email = document.getElementById('email').value;


    document.getElementById('client-signature-data').value = clientSignaturePad.toDataURL();
    document.getElementById('technician-signature-data').value = technicianSignaturePad.toDataURL();
    const name = document.getElementById('name').value.trim(); // Ensure to get the value
    const date = document.getElementById('date').value.trim(); // Ensure to get the value

    try {
        const formElement = document.querySelector('.container');

        console.log('Starting image load check.');

        // Ensure all images are loaded
        await new Promise((resolve, reject) => {
    const img = formElement.querySelector('img');
    let imageLoadTimeout;

    if (!img) {
        console.log('No image found in the form, proceeding.');
        resolve();
        return;
    }

    // Set a timeout to ensure we don't wait indefinitely
    imageLoadTimeout = setTimeout(() => {
        console.warn('Image loading timed out. Proceeding with PDF generation.');
        resolve();
    }, 10000); // 5 seconds timeout

    if (img.complete) {
        console.log(`Image already loaded: ${img.src}`);
        clearTimeout(imageLoadTimeout);
        resolve();
    } else {
        img.onload = () => {
            console.log(`Image loaded successfully: ${img.src}`);
            clearTimeout(imageLoadTimeout);
            resolve();
        };
        img.onerror = () => {
            console.error(`Error loading image: ${img.src}`);
            clearTimeout(imageLoadTimeout);
            resolve(); // Proceed even if the image fails to load
        };
    }
});
      document.getElementById('loading-message').style.display = 'none';

        console.log('Generating canvas.');
        const canvas = await html2canvas(formElement, {
    scale: window.devicePixelRatio, // Ensure it matches the device pixel ratio for better resolution
    useCORS: true,
    logging: true,
    x: 0,
    y: 0,
    scrollX: -window.scrollX, // Compensate for any scrolling
    scrollY: -window.scrollY, // Compensate for any scrolling
    width: formElement.scrollWidth, // Use scrollWidth to capture full content width
    height: formElement.scrollHeight, // Use scrollHeight to capture full content height
});
             
document.getElementById('loading-message').style.display = 'block';

                const imgData = canvas.toDataURL('image/png',0.5);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', [canvas.width * 0.264583, canvas.height * 0.264583]);
                pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width * 0.264583, canvas.height * 0.264583, undefined, 'FAST');

            

         // Set metadata with the email
        pdf.setProperties({
        title: 'Elevator Service/Breakdown/Inspection Sheet',
        subject: 'Service Form PDF',
        author: 'George Steuart Solutions (PVT) Ltd',
        keywords: 'Elevator, Service, Breakdown, PDF',
        creator: 'Priyanjith Bandara',
        pv:       '6957',

       });


        // Add custom metadata using XMP format
        const customMetadata = `
            <rdf:Description xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
                <email>${email}</email>
            </rdf:Description>
        `;
        pdf.addMetadata(customMetadata);

        
        const pdfBlob = pdf.output('blob', { compress: true });
            const fileName = `${name}_${date}.pdf`;

            const reader = new FileReader();
                reader.onloadend = async function (e) {
                    const arrayBuffer = e.target.result;
                    const file = new Blob([arrayBuffer], { type: 'application/pdf' });

                    const formData = new FormData();
                    formData.append('pdf', file, fileName);

                    console.log('PDF generated and ready for submission.');

                try {
                    await uploadToGoogleDrive(pdfBlob, fileName);

                    document.getElementById('loading-message').style.display = 'none';
                    document.getElementById('message').style.display = 'block';
                } catch (error) {
                    console.error('Error uploading PDF to Google Drive:', error);
                    alert('An error occurred while uploading the PDF. Please try again.');
                    document.getElementById('loading-message').style.display = 'none';

                    document.getElementById('loading-message').style.display = 'none';
                }
            };
            reader.readAsDataURL(pdfBlob);

        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('An error occurred while generating the PDF. Please try again.');
            document.getElementById('loading-message').style.display = 'none';
        }
    });
    
        async function refreshAccessToken() {
            refreshToken = '1//04KpKozGZkgVnCgYIARAAGAQSNwF-L9IrlFI2RiUGlEQavLMafZa6GHC44WGIKRHfVLZeJZHv_3TRuiPMvvyKJ1rk1nzktlPzWpY';
            clientId = '515981529627-in314q7stikcsvasfkdsk4l3ktslnif6.apps.googleusercontent.com';
            clientSecret = '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';
    
            const params = new URLSearchParams();
            params.append('client_id', clientId);
            params.append('client_secret', clientSecret);
            params.append('refresh_token', refreshToken);
            params.append('grant_type', 'refresh_token');
    
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });
    
            const data = await response.json();
            if (!response.ok) {
                throw new Error('Error refreshing access token');
            }
    
            return data.access_token;
        }
    
        async function uploadToGoogleDrive(fileBlob, fileName) {
            const accessToken = await refreshAccessToken();
            const folderId = '13vBo1IdA1l2PYiDb1qdJkltHEARFs991';
    
            const metadata = {
                name: fileName,
                mimeType: 'application/pdf',
                parents: [folderId]
            };
    
            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', fileBlob);
    
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: formData
            });
    
            if (!response.ok) {
                throw new Error('Error uploading file to Google Drive');
            }
        }
    
    </script>
    
</body>
</html>
